##第一步 registry:2 容器创建、端口、镜像存储路径、证书路径、
sudo docker run -d -p 5010:5000 --restart=always \
	-v $HOME/docker/registry/_data:/var/lib/registry \
	-v $HOME/docker/registry/certs:/certs   \
	-e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/image.ib2000.com.crt   \
	-e REGISTRY_HTTP_TLS_KEY=/certs/image.ib2000.com.key  \
	registry:2
  
 ##第二步 nginx 代理设置
upstream image-registry {
        ip_hash;
        server 127.0.0.1:5010 weight=5;

}

server {
        listen 8443;
        listen 443;
        server_name image.ib2000.com;

        ssl on;
        ssl_certificate /home/wyb/docker/registry/certs/image.ib2000.com.crt;
        ssl_certificate_key /home/wyb/docker/registry/certs/image.ib2000.com.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;
        ssl_prefer_server_ciphers on;


        location / {
                root html;
                index index.html index.htm index.jsp;
                proxy_pass https://image-registry;
                proxy_redirect off;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                client_max_body_size 10m;
                client_body_buffer_size 128k;
                proxy_connect_timeout 90;
                proxy_send_timeout 90;
                proxy_read_timeout 90;
        }
}
